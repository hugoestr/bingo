<!doctype html>

<html>
  <head>
    <style>
      
      table { 
        border-style: solid;
        font-size: 1em;     
        width: 800px;
        height: 500px;
      }  
      th {color: gray;}
      tr {border-style: solid; }
      td {
          border-style: solid;
          text-align: center;
          width: 160px;
          height: 100px;
        }
        
        .center { 
          background: #CCCCFF;
          border-color: orange;
        }
       .selected { background: #CCCCFF ;}

      /* th { border-style: solid;} */
    </style>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="public/libs/jquery-2.0.3.js" ></script>  
    <Script src="public/libs/carhartl-jquery-cookie-3caf209/jquery.cookie.js"></script>
    <script src="public/libs/underscore.js" ></script>  

    <script>
     /* data */
     var data = ["hello", "there", "babo", "new", "gago", "this is a lot longer"];
     var content = [
          "'This group should be called....'",
          "Mislabelling a bully",
          "Playing the 'topic' card",
          "Leaving a thread.  JUST KIDDING!",
          "What would John and Hank think?",
          "Unnecessarily tagging someone just to bitch them out",
          "THAT WASN'T AD HOMINEM!",
          "'I never actually say X!'",
          "Bully denies being a bully in a fit of righteous indignation",
          "Someone forgot to be awesome",
          "Actual vlogbrothers reference",
          "Overdone political drum solo",
          "Post lamenting all the mean posts",
          "saying who can and can't be a Nerdfighter",
          "Mislabelling a troll",
          "'SAFE SPACE'",
          "Grammar correction",
          "TRIGGER WARNING",
          "Soliciting pity",
          "Accusing someone of following you from thread to thread",
          "'your opinion is WRONG!'",
          "Doctor Who post",
          "Flounce post!",
          "This is my FB wall, right?",
          "Arguing the definition of an -ism",
          "Harry Potter post",
          "passive agressive smiley face",
          "'I thought this was ADULT Nerdfighters'",
          "I have a mental illness!",
          "Someone posting TL;DR on a well thought out statement, responding with something pithy",
          "You're increasing world suck"];



     /* modules */

     var socket = io.connect('http://localhost');

     var positions = (function($,_) { 
       var p = {};


       p.clear = function() {
          setCookie([]);
       }


       p.remove = function(position){
          removePosition(position);
       }

       p.add = function(position){
          addPosition(position);
       }

       p.get = function(){
          return getPositions(); 
       }


       function getPositions(){
          var result = [];
          
          var value = $.cookie("selectedCells");

          if (value != undefined){
            result  = JSON.parse(value);
          }

          return result;
       }

       function removePosition(position){
            var positions = getPositions();
            var newPositions = _.without(positions, position);

            setCookie(newPositions);
       }
       
       function addPosition(position){
         var positions = getPositions();
         positions.push(position);
         var newPositions = _.uniq(positions);
          setCookie(newPositions);
       }

       function setCookie(list){
         $.cookie("selectedCells", JSON.stringify(list.sort()), {expires: 30});
       }

       return p;
   }($,_));

     var card = (function($, _, positions){
        var boardCookie = "board";
        var c = {};

        c.load = function(className, data){
          (boardExists()) ? retrieve(className) : create(className, data);
        }

        c.create = function(className, data){
          create(className, data);
        }

        function boardExists(){
          var result = false;
          var board = $.cookie(boardCookie);

          if (board) {
            result = true;
          }
          return result;
        }

        function retrieve(className) {
          var value =  $.cookie(boardCookie);
          var board = JSON.parse(value);
          var selected = positions.get();
          
          populate(className, board, selected);
        }

        function create(className, data){
          var board = select(data, 12 , "DFTBA");
          $.cookie(boardCookie, JSON.stringify(board), {expires: 365});
          var selected = positions.get();
          
          populate(className, board, selected);
        };

        function populate(className, data, selected){
          var selector = "." + className;
          var t = table(data, selected);
          $(selector).html(t);
        }

        function select(data, centerPosition, centerValue){
          var result = _.shuffle(data).splice(0, 24);  
          result.splice(centerPosition, 0, centerValue); 

          return result;
        }

        function table(data, selected){
          var result = "<table border='1'>";

          result += "<tr><th>D</th><th>F</th><th>T</th><th>B</th><th>A</th></tr>";
          result += grid(data, selected);
          result += "</table>";

          return result;
        }

        function td(data, className, position){
          return "<td class='" + className + 
            "' data-position='" + position +  "' >" + 
            data +  "</td>";
        }

        function classes(main, selected, index){
          var result = main;
          
          if (_.contains(selected, index.toString())){
             result += " selected";
          }

          return result;
        }

        function grid(data, selected){
          var result = "";
          var count = 0;
          
          for (var i = 0; i < data.length; i++){
            if (count % 5 == 0) {
              if (result != ""){
                result += "</tr>";
              }
              result += "<tr>";
              count  = 0;
            }
            
            result += (i == 12) ? 
                      td(data[i], "center") :
                      td(data[i], classes("cell", selected, i), i);
            count++;
          }

          result += "</tr>";

          return result;
        }

        return c;    
     }($,_, positions));  

     /* start */ 
     $(document).ready(function(){
         card.load("board", content);  

         $("#reset").click(function(){
            card.create("board", content); 
         });

         $("#clear").click(function(){
            $(".cell").removeClass("selected"); 
            positions.clear();
         });

         $("table").on("click", ".cell", function(){
           var classes = _.flatten([$(this).attr("class").split(" ")]);
           
           if (_.contains(classes, "selected")) {
              $(this).removeClass("selected");    

              var position = $(this).attr("data-position");
              positions.remove(position); 
           } else {
              $(this).addClass("selected");    
              
              var position = $(this).attr("data-position");
              positions.add(position); 
           }
         });

         $("#won").click(function(){
           socket.emit("winning", {user: "hugo"});
         });
         
     });

  socket.on('news', function (data) {
    console.log(data);
  });
     

    </script>
  </head>
  <body>
    <h1>Nerdfighter Bingo</h1>
    <input type="button" id="reset" value="New board" />
    <input type="button" id="clear" value="Clear board" />
    <input type="button" id="won" value="I won!" />
    <div class="board"></div>
    <p>Version 0.0.2</p>
    <h5>Version history</h5>
    <ul>
      <li>0.0.4 -- added button to communicate wins</li> 
      <li>0.0.3 -- colors cells when clicked; added clear board button; remembers selection on each refresh; remembers selected cells for 2 weeks</li>
      <li>0.0.2 -- script remembers your board until reset for a year</li>
      <li>0.0.1 -- script creates board</li>
    </ul>
      <p> &copy; 2014 Lame Games Studios. All rights reserved <p>
  </body>
</html>
